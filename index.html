<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Sheet Chat</title>
<style>
body { 
  font-family: Arial, sans-serif; 
  background: #f3f3f3; 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  height: 100vh; 
  margin: 0; 
}
#chat-container { 
  width: 500px; 
  max-height: 90vh;
  background: #fff; 
  border-radius: 10px; 
  box-shadow: 0 0 10px rgba(0,0,0,0.2); 
  display: flex; 
  flex-direction: column; 
}
#instructions{
  padding: 10px;
  border-bottom: 1px solid #ccc;
  background: #f9f9f9;
  font-size: 14px;
}
#messages { 
  flex: 1; 
  overflow: auto; 
  padding: 10px; 
  display: flex;
  flex-direction: column; 
}
.message { 
  margin-bottom: 10px; 
  transition: background 0.5s;
}
.message span { 
  font-weight: bold; 
  margin-right: 5px; 
}
.new-message{
  background: #fffa8b;
}
#send-container {
  display: flex;
  padding: 5px 10px;
  border-top: 1px solid #ccc;
  gap: 5px;
}
#send-container input[type="text"], 
#send-container input[type="email"] {
  padding: 5px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 5px;
}
#name-input { width: 25%; }
#email-input { width: 35%; }
#msg-input { flex: 1; }
#send-btn {
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 5px;
  border: none;
  background: #4CAF50;
  color: white;
}
</style>
</head>
<body>
<div id="chat-container">
  <div id="instructions">
    Enter your name (required) and message below, then hit Send.<br>
    Messages will appear automatically once confirmed in the Sheet.
  </div>
  <div id="messages"></div>
  <div id="send-container">
    <input type="text" id="name-input" placeholder="Name (required)">
    <input type="email" id="email-input" placeholder="Email (required)">
    <input type="text" id="msg-input" placeholder="Type message...">
    <button id="send-btn">Send</button>
  </div>
</div>

<script>
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1qUH-oFpAIB1y4Tzaor5-mfC7ZuQ9DO8LnZ1_43ktEsw/gviz/tq?tqx=out:csv";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScGCKzBOUC0k77GUWx5pbidtTyI32DURNLNrlpD6Srzi0m7aQ/formResponse";

// Entry IDs from your form
const NAME_ENTRY_ID = "entry.727031839";
const MESSAGE_ENTRY_ID = "entry.1492853225";
const EMAIL_ENTRY_ID = "entry.611414622";

const messagesDiv = document.getElementById('messages');
const nameInput = document.getElementById('name-input');
const emailInput = document.getElementById('email-input');
const msgInput = document.getElementById('msg-input');
const sendBtn = document.getElementById('send-btn');

let messages = [];

// Request notifications
if (Notification.permission !== "granted") Notification.requestPermission();

// Fetch messages
async function fetchMessages(){
  try {
    const res = await fetch(SHEET_CSV_URL);
    const text = await res.text();
    const rows = text.split("\n").slice(1);
    const allMessages = rows.map(row => {
      const cols = row.split(",");
      return { timestamp: cols[0], name: cols[1], message: cols[2], email: cols[3] };
    });

    messagesDiv.innerHTML = "";
    allMessages.forEach(m => renderMessage(m));
    messages = allMessages;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  } catch(e){console.warn("Fetch failed", e);}
}

// Render a single message
function renderMessage(m){
  const sender = m.name.trim() ? m.name : (m.email || "Anonymous");
  const div = document.createElement('div');
  div.className = 'message';
  div.innerHTML = `<span>${sender}:</span> ${m.message}`;
  messagesDiv.appendChild(div);
}

// Poll for new messages every 3 seconds
setInterval(fetchMessages, 3000);

// Send message
sendBtn.addEventListener('click', ()=>{
  const name = nameInput.value.trim();
  if(!name) return alert("Name is required!");
  const email = emailInput.value.trim();
  const msg = msgInput.value.trim();
  if(!msg) return;

  const formData = new FormData();
  formData.append(NAME_ENTRY_ID, name);
  formData.append(EMAIL_ENTRY_ID, email);
  formData.append(MESSAGE_ENTRY_ID, msg);

  fetch(FORM_URL,{
    method:'POST',
    body: formData,
    mode:'no-cors'
  });

  msgInput.value="";
});

// Initial load
fetchMessages();
</script>
</body>
</html>
